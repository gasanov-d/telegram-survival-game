<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Survival World</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  overflow: hidden;
  background: #1b5e20;
}
canvas { display: block; }

/* Джойстик */
#joystick {
  position: fixed;
  bottom: 40px;
  left: 40px;
  width: 120px;
  height: 120px;
  border-radius: 50%;
  background: rgba(0,0,0,0.35);
}
#stick {
  position: absolute;
  left: 35px;
  top: 35px;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: #fff;
}
</style>
</head>

<body>

<canvas id="game"></canvas>

<div id="joystick">
  <div id="stick"></div>
</div>

<script>
/* === TELEGRAM === */
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

/* === CANVAS === */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
resize();
addEventListener("resize", resize);

/* === WORLD === */
const world = {
  width: 3000,
  height: 3000
};

/* === PLAYER === */
const player = {
  x: world.width / 2,
  y: world.height / 2,
  size: 28,
  speed: 4,
  dx: 0,
  dy: 0
};

/* === CAMERA === */
const camera = { x: 0, y: 0 };

/* === OBJECTS === */
const trees = [];
for (let i = 0; i < 30; i++) {
  trees.push({
    x: Math.random() * world.width,
    y: Math.random() * world.height,
    size: 40
  });
}

const mountains = [];
for (let i = 0; i < 15; i++) {
  mountains.push({
    x: Math.random() * world.width,
    y: Math.random() * world.height,
    size: 100
  });
}

const npcs = [
  { x: 1400, y: 1500, size: 26, dir: 1 },
  { x: 1600, y: 1450, size: 26, dir: -1 }
];

/* === JOYSTICK === */
const joystick = document.getElementById("joystick");
const stick = document.getElementById("stick");
let dragging = false;

joystick.addEventListener("touchstart", () => dragging = true);
joystick.addEventListener("touchend", () => {
  dragging = false;
  stick.style.left = "35px";
  stick.style.top = "35px";
  player.dx = player.dy = 0;
});

joystick.addEventListener("touchmove", e => {
  if (!dragging) return;
  const rect = joystick.getBoundingClientRect();
  const t = e.touches[0];

  let dx = t.clientX - rect.left - 60;
  let dy = t.clientY - rect.top - 60;
  const dist = Math.hypot(dx, dy);
  const max = 40;

  if (dist > max) {
    dx *= max / dist;
    dy *= max / dist;
  }

  stick.style.left = dx + 60 - 25 + "px";
  stick.style.top = dy + 60 - 25 + "px";

  player.dx = dx / max;
  player.dy = dy / max;
});

/* === COLLISION === */
function blocked(nx, ny) {
  return mountains.some(m =>
    Math.abs(nx - m.x) < m.size / 2 &&
    Math.abs(ny - m.y) < m.size / 2
  );
}

/* === UPDATE === */
function update() {
  const nx = player.x + player.dx * player.speed;
  const ny = player.y + player.dy * player.speed;

  if (!blocked(nx, ny)) {
    player.x = Math.max(0, Math.min(world.width, nx));
    player.y = Math.max(0, Math.min(world.height, ny));
  }

  npcs.forEach(n => {
    n.x += Math.sin(Date.now() / 800) * 0.6;
  });

  camera.x = player.x - canvas.width / 2;
  camera.y = player.y - canvas.height / 2;
}

/* === DRAW === */
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  /* ground */
  ctx.fillStyle = "#2e7d32";
  ctx.fillRect(-camera.x, -camera.y, world.width, world.height);

  /* mountains */
  ctx.fillStyle = "#5d4037";
  mountains.forEach(m => {
    ctx.fillRect(
      m.x - camera.x - m.size / 2,
      m.y - camera.y - m.size / 2,
      m.size, m.size
    );
  });

  /* trees */
  ctx.fillStyle = "#1b5e20";
  trees.forEach(t => {
    ctx.fillRect(
      t.x - camera.x - t.size / 2,
      t.y - camera.y - t.size / 2,
      t.size, t.size
    );
  });

  /* NPCs */
  ctx.fillStyle = "#03a9f4";
  npcs.forEach(n => {
    ctx.fillRect(
      n.x - camera.x - n.size / 2,
      n.y - camera.y - n.size / 2,
      n.size, n.size
    );
  });

  /* player */
  ctx.fillStyle = "#ffeb3b";
  ctx.fillRect(
    player.x - camera.x - player.size / 2,
    player.y - camera.y - player.size / 2,
    player.size, player.size
  );
}

/* === LOOP === */
function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>

</body>
</html>
