<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Island Survival</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: #0f172a;
  font-family: Arial, sans-serif;
  overflow: hidden;
  touch-action: none;
}

#game {
  position: relative;
  width: 100vw;
  height: 100vh;
  background: #166534;
}

#player {
  position: absolute;
  width: 32px;
  height: 32px;
  background: yellow;
  border-radius: 6px;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
}

#hud {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  padding: 8px;
  background: rgba(0,0,0,0.6);
  color: white;
  display: flex;
  justify-content: space-around;
  font-size: 14px;
}

#actions {
  position: absolute;
  bottom: 80px;
  right: 10px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.btn {
  background: #2563eb;
  color: white;
  padding: 12px;
  border-radius: 10px;
  text-align: center;
  font-size: 14px;
}

#joystick {
  position: absolute;
  bottom: 20px;
  left: 20px;
  width: 120px;
  height: 120px;
  border-radius: 50%;
  background: rgba(255,255,255,0.1);
}

#stick {
  position: absolute;
  left: 40px;
  top: 40px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: white;
}
</style>
</head>

<body>
<div id="game">
  <div id="hud">
    ‚ù§Ô∏è <span id="hp">100</span>
    ‚ö° <span id="energy">100</span>
    üå≤ <span id="wood">0</span>
  </div>

  <div id="player"></div>

  <div id="actions">
    <div class="btn" onclick="collectWood()">üå≤ –°–æ–±—Ä–∞—Ç—å –¥–µ—Ä–µ–≤–æ</div>
    <div class="btn" onclick="buildHouse()">üè† –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –¥–æ–º</div>
  </div>

  <div id="joystick">
    <div id="stick"></div>
  </div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

/* ====== –ù–ê–°–¢–†–û–ô–ö–ò ====== */
const TILE = 48;
const MAP_W = 20;
const MAP_H = 14;

/* ====== –°–û–°–¢–û–Ø–ù–ò–ï –ò–ì–†–´ ====== */
let state = {
  player: { x: 10, y: 7 },
  hp: 100,
  energy: 100,
  wood: 0,
  stone: 0
};

const game = document.getElementById("game");
const playerEl = document.getElementById("player");

/* ====== –ö–ê–†–¢–ê ====== */
const map = [];
for (let y = 0; y < MAP_H; y++) {
  map[y] = [];
  for (let x = 0; x < MAP_W; x++) {
    const r = Math.random();
    let type = "grass";
    if (r < 0.15) type = "tree";
    else if (r < 0.25) type = "stone";
    map[y][x] = type;
  }
}

/* ====== –û–¢–†–ò–°–û–í–ö–ê –ö–ê–†–¢–´ ====== */
function drawMap() {
  game.innerHTML = "";
  for (let y = 0; y < MAP_H; y++) {
    for (let x = 0; x < MAP_W; x++) {
      const tile = document.createElement("div");
      tile.className = "tile " + map[y][x];
      tile.style.left = x * TILE + "px";
      tile.style.top = y * TILE + "px";

      tile.onclick = () => interact(x, y);

      game.appendChild(tile);
    }
  }
  game.appendChild(playerEl);
}

/* ====== –ò–ì–†–û–ö ====== */
function drawPlayer() {
  playerEl.style.left = state.player.x * TILE + 8 + "px";
  playerEl.style.top = state.player.y * TILE + 8 + "px";
}

/* ====== –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–ï ====== */
function interact(x, y) {
  const dx = Math.abs(x - state.player.x);
  const dy = Math.abs(y - state.player.y);
  if (dx > 1 || dy > 1) return;

  if (map[y][x] === "tree") {
    map[y][x] = "grass";
    state.wood++;
  }
  if (map[y][x] === "stone") {
    map[y][x] = "grass";
    state.stone++;
  }

  updateHUD();
  drawMap();
  drawPlayer();
}

/* ====== HUD ====== */
function updateHUD() {
  hp.textContent = state.hp;
  energy.textContent = state.energy;
  wood.textContent = state.wood;
}

/* ====== –î–ñ–û–ô–°–¢–ò–ö ====== */
let dragging = false;
const joystick = document.getElementById("joystick");
const stick = document.getElementById("stick");

joystick.addEventListener("touchstart", () => dragging = true);
joystick.addEventListener("touchend", () => {
  dragging = false;
  stick.style.left = "40px";
  stick.style.top = "40px";
});

joystick.addEventListener("touchmove", e => {
  if (!dragging) return;
  const rect = joystick.getBoundingClientRect();
  const t = e.touches[0];
  const dx = t.clientX - rect.left - 60;
  const dy = t.clientY - rect.top - 60;

  const mx = Math.sign(dx);
  const my = Math.sign(dy);

  movePlayer(mx, my);
});

/* ====== –î–í–ò–ñ–ï–ù–ò–ï ====== */
function movePlayer(dx, dy) {
  const nx = state.player.x + dx;
  const ny = state.player.y + dy;
  if (nx < 0 || ny < 0 || nx >= MAP_W || ny >= MAP_H) return;
  state.player.x = nx;
  state.player.y = ny;
  drawPlayer();
}

/* ====== –°–¢–ê–†–¢ ====== */
drawMap();
drawPlayer();
updateHUD();
</script>
