<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Survival</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  overflow: hidden;
  background: #2e7d32;
}
canvas { display: block; }

/* Джойстик */
#joystick {
  position: fixed;
  bottom: 40px;
  left: 40px;
  width: 120px;
  height: 120px;
  border-radius: 50%;
  background: rgba(0,0,0,0.3);
}
#stick {
  position: absolute;
  left: 35px;
  top: 35px;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: rgba(255,255,255,0.9);
}

/* Кнопка удара */
#action {
  position: fixed;
  bottom: 60px;
  right: 40px;
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: rgba(255,0,0,0.85);
  color: #fff;
  font-size: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  user-select: none;
}
</style>
</head>

<body>

<canvas id="game"></canvas>

<div id="joystick"><div id="stick"></div></div>
<div id="action">УДАР</div>

<script>
/* === TELEGRAM === */
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

/* === CANVAS === */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = innerWidth;
canvas.height = innerHeight;

/* === МИР === */
const world = { width: 3000, height: 3000 };

/* === ИГРОК === */
const player = {
  x: world.width / 2,
  y: world.height / 2,
  size: 28,
  speed: 4,
  dx: 0,
  dy: 0
};

/* === КАМЕРА === */
const camera = { x: 0, y: 0 };

/* === ДЕРЕВЬЯ === */
const trees = [];
for (let i = 0; i < 25; i++) {
  trees.push({
    x: Math.random() * world.width,
    y: Math.random() * world.height,
    size: 40,
    hp: 3
  });
}

/* === ДЖОЙСТИК === */
const joystick = document.getElementById("joystick");
const stick = document.getElementById("stick");
let drag = false;

joystick.ontouchstart = () => drag = true;
joystick.ontouchend = () => {
  drag = false;
  stick.style.left = "35px";
  stick.style.top = "35px";
  player.dx = player.dy = 0;
};

joystick.ontouchmove = e => {
  if (!drag) return;
  const r = joystick.getBoundingClientRect();
  const t = e.touches[0];
  let dx = t.clientX - r.left - 60;
  let dy = t.clientY - r.top - 60;
  const d = Math.hypot(dx, dy);
  if (d > 40) { dx *= 40/d; dy *= 40/d; }
  stick.style.left = `${dx+60-25}px`;
  stick.style.top = `${dy+60-25}px`;
  player.dx = dx/40;
  player.dy = dy/40;
};

/* === УДАР === */
document.getElementById("action").onclick = () => {
  trees.forEach(t => {
    const dist = Math.hypot(player.x - t.x, player.y - t.y);
    if (dist < 60 && t.hp > 0) {
      t.hp--;
      if (t.hp === 0) t.dead = true;
    }
  });
};

/* === ИГРОВОЙ ЦИКЛ === */
function update() {
  player.x += player.dx * player.speed;
  player.y += player.dy * player.speed;

  player.x = Math.max(0, Math.min(world.width, player.x));
  player.y = Math.max(0, Math.min(world.height, player.y));

  camera.x = player.x - canvas.width / 2;
  camera.y = player.y - canvas.height / 2;
}

function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  ctx.fillStyle = "#388e3c";
  ctx.fillRect(-camera.x, -camera.y, world.width, world.height);

  trees.forEach(t => {
    if (t.dead) return;
    ctx.fillStyle = "#1b5e20";
    ctx.fillRect(
      t.x - camera.x - t.size/2,
      t.y - camera.y - t.size/2,
      t.size, t.size
    );
  });

  ctx.fillStyle = "#ffeb3b";
  ctx.fillRect(
    player.x - camera.x - player.size/2,
    player.y - camera.y - player.size/2,
    player.size, player.size
  );
}

function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>

</body>
</html>
