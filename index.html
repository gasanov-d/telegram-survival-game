<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Survival Prototype</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: #111;
  color: #fff;
  overflow: hidden;
  font-family: Arial;
}

#game {
  position: relative;
  width: 100vw;
  height: 100vh;
  background: #2e7d32;
}

.tile {
  position: absolute;
  width: 40px;
  height: 40px;
  box-sizing: border-box;
}

.grass { background: #2e7d32; }
.tree  { background: #1b5e20; }
.house { background: #795548; }

#player {
  position: absolute;
  width: 32px;
  height: 32px;
  background: yellow;
  z-index: 10;
  border-radius: 4px;
}

#ui {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  background: rgba(0,0,0,0.7);
  padding: 8px;
  display: flex;
  justify-content: space-between;
}

.btn {
  background: #1976d2;
  padding: 10px;
  border-radius: 6px;
  text-align: center;
  user-select: none;
}

#joystick {
  position: absolute;
  bottom: 80px;
  left: 20px;
  width: 120px;
  height: 120px;
  border-radius: 50%;
  background: rgba(255,255,255,0.1);
}

#stick {
  position: absolute;
  left: 40px;
  top: 40px;
  width: 40px;
  height: 40px;
  background: rgba(255,255,255,0.6);
  border-radius: 50%;
}
</style>
</head>

<body>

<div id="game"></div>
<div id="player"></div>

<div id="joystick">
  <div id="stick"></div>
</div>

<div id="ui">
  <div class="btn" onclick="buildHouse()">üè† –°—Ç—Ä–æ–∏—Ç—å</div>
  <div>üå≤ –î–µ—Ä–µ–≤–æ: <span id="wood">0</span></div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const game = document.getElementById("game");
const player = document.getElementById("player");
const woodEl = document.getElementById("wood");

const TILE = 40;
const MAP_W = 20;
const MAP_H = 15;

let map = [];
let wood = 0;

let px = 5;
let py = 5;

function createMap() {
  game.innerHTML = "";
  map = [];

  for (let y = 0; y < MAP_H; y++) {
    map[y] = [];
    for (let x = 0; x < MAP_W; x++) {
      let type = Math.random() < 0.2 ? "tree" : "grass";
      map[y][x] = type;

      const tile = document.createElement("div");
      tile.className = "tile " + type;
      tile.style.left = x * TILE + "px";
      tile.style.top  = y * TILE + "px";

      tile.onclick = () => {
        if (map[y][x] === "tree") {
          map[y][x] = "grass";
          tile.className = "tile grass";
          wood++;
          woodEl.textContent = wood;
        }
      };

      game.appendChild(tile);
    }
  }
}

function renderPlayer() {
  player.style.left = px * TILE + 4 + "px";
  player.style.top  = py * TILE + 4 + "px";
}

function move(dx, dy) {
  const nx = px + dx;
  const ny = py + dy;
  if (nx < 0 || ny < 0 || nx >= MAP_W || ny >= MAP_H) return;
  px = nx;
  py = ny;
  renderPlayer();
}

function buildHouse() {
  if (wood < 5) return alert("–ù—É–∂–Ω–æ 5 –¥–µ—Ä–µ–≤–∞");
  if (map[py][px] !== "grass") return;

  map[py][px] = "house";
  const index = py * MAP_W + px;
  game.children[index].className = "tile house";
  wood -= 5;
  woodEl.textContent = wood;
}

//// JOYSTICK
const joystick = document.getElementById("joystick");
const stick = document.getElementById("stick");

let joyX = 0, joyY = 0;

joystick.addEventListener("touchmove", e => {
  const r = joystick.getBoundingClientRect();
  const t = e.touches[0];
  joyX = t.clientX - r.left - 60;
  joyY = t.clientY - r.top  - 60;

  joyX = Math.max(-30, Math.min(30, joyX));
  joyY = Math.max(-30, Math.min(30, joyY));

  stick.style.left = joyX + 40 + "px";
  stick.style.top  = joyY + 40 + "px";
});

joystick.addEventListener("touchend", () => {
  joyX = joyY = 0;
  stick.style.left = "40px";
  stick.style.top  = "40px";
});

setInterval(() => {
  if (Math.abs(joyX) > 10) move(Math.sign(joyX), 0);
  if (Math.abs(joyY) > 10) move(0, Math.sign(joyY));
}, 200);

createMap();
renderPlayer();
</script>

</body>
</html>
